---
title: "Assignment 4"
subtitle:  "Alternative Functional Forms and Panel Estimates"
author: "Ivan Stordal & Irjan Vikre"
date: last-modified
date-format: "dddd D MMM, YYYY"
csl: hvl_apa7_stil_bokmal_v1
lang: en-GB
format:
  html: default
  typst:
    papersize: a4
  pdf: 
    documentclass: article
    number-sections: true
    keep-tex: true
    papersize: A4
    fig-pos: "H"
abstract: ""
editor: 
  markdown: 
    wrap: sentence
echo: false
bibliography:
---

```{r}
#| label: setup
#| message: false
library(tidyverse)
library(readxl)
library(restatapi)
library(DescTools)
library(ggrepel)
library(flextable)
library(modelr)
library(plm)
library(broom)
library(sandwich)
```

```{r}
toc_txt <- get_eurostat_toc(mode = "txt")
```

```{r}
gdp_tabs <- toc_txt |> 
   filter(
     str_detect(
       string = title,
       pattern = '[Gg][Dd][Pp]'
       ) &
     str_detect(
       string = title,
       pattern = '[Nn][Uu][Tt][Ss]\\s*3'
       )
     ) |> 
  select(title, code)
```

```{r}
gdp_tabs |> 
  select(title, code) |> 
  flextable()  |> 
  width(1, width = 3.5) |> 
  width(2, width = 1.5)
```

```{r}
# description nama_10r_3gdp
dsd_gdp <- get_eurostat_dsd("nama_10r_3gdp")
```

```{r}
dsd_gdp |> 
  filter(concept %in% c('freq', 'unit')) |> 
  flextable()  |> 
  width(j = 1, width = 1) |> 
  width(j = 2, width = 2) |> 
  width(j = 3, width = 2)
```

```{r}
dsd_gdp |> 
  filter(concept %in% c('geo')) |> 
  head(n = 10) |> 
  flextable()  |> 
  width(j = 1, width = 1) |> 
  width(j = 2, width = 2) |> 
  width(j = 3, width = 2)
```


```{r}
#| eval: true
#| cache: true
gdp <- get_eurostat_data(
  id = "nama_10r_3gdp",
  filters = list(
    nuts_level = "3",
    unit = "MIO_PPS_EU27_2020"
  ),
  exact_match = FALSE,
  date_filter = 2000:2023,
  stringsAsFactors = FALSE
  ) |> 
  mutate(
    gdp_n3 = 1000000 * values
  ) |> 
  select(-c(unit, values)) |> 
  filter(str_length(geo) == 5) |> 
  as_tibble()
```

```{r}
dim(gdp)
```

```{r}
gdp
```

```{r}
gdp |> 
  filter(geo == "IE053") |> 
  print(n = 25)
```

```{r}
ie_data <- tibble(
  geo = c("IE053", "IE053", "IE053"),
  time = c("2015", "2016", "2017"),
  gdp_n3 = c(NA, NA, NA)
)
```

```{r}
gdp <- rbind(gdp, ie_data)
```

```{r}
gdp <- gdp |> 
  arrange(geo, time) |> 
  mutate(
    gdp_n3 = zoo::na.approx(gdp_n3)
  )
```

```{r}
gdp |> 
  filter(geo == "IE053") |> 
  print(n = 25)
```

```{r}
pop_tabs <- toc_txt |>
  filter(
    str_detect(
      title,
      pattern = "[Pp][Oo][Pp][Uu][Ll][Aa][Tt][Ii][Oo][Nn]"
    ) &
    str_detect(
      title,
      pattern = "[Nn][Uu][Tt][Ss]\\s*3"
    )
  ) |>
  select(title, code)
```




```{r}
dsd_pop <- get_eurostat_dsd("demo_r_pjanaggr3")
```


```{r}
dsd_pop |>
  filter(concept %in% c("freq", "sex", "age", "unit")) |>
  flextable()
```


# Oppgave 2.iii




```{r}
pop <- get_eurostat_data(
  id = "demo_r_pjanaggr3",
  filters = list(
    sex = "T",
    age = "TOTAL"
  ),
  date_filter = 2000:2023,
  exact_match = FALSE,
  stringsAsFactors = FALSE
) |>
  mutate(
    # Verdiene er i tusen personer â†’ konverter til personer
    pop_n3 = 1000 * values
  ) |>
  select(-c(values, sex, age, unit)) |>
  as_tibble()
```





# Oppgave 2.iv


```{r}
pop <- pop |>
  filter(str_length(geo) == 5)
```




```{r}
dim(pop)
```


```{r}
pop
```



