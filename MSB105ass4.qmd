---
title: "Assignment 4"
subtitle:  "Alternative Functional Forms and Panel Estimates"
author: "Ivan Stordal & Irjan Vikre"
date: last-modified
date-format: "dddd D MMM, YYYY"
csl: hvl_apa7_stil_bokmal_v1
lang: en-GB
format:
  html: default
  typst:
    papersize: a4
  pdf: 
    documentclass: article
    number-sections: true
    keep-tex: true
    papersize: A4
    fig-pos: "H"
abstract: ""
editor: 
  markdown: 
    wrap: sentence
echo: false
---

```{r}
#| label: setup
#| message: false
library(tidyverse)
library(readxl)
library(restatapi)
library(DescTools)
library(ggrepel)
library(flextable)
library(modelr)
library(plm)
library(broom)
library(sandwich)
```

```{r}
toc_txt <- get_eurostat_toc(mode = "txt")
```

```{r}
gdp_tabs <- toc_txt |> 
   filter(
     str_detect(
       string = title,
       pattern = '[Gg][Dd][Pp]'
       ) &
     str_detect(
       string = title,
       pattern = '[Nn][Uu][Tt][Ss]\\s*3'
       )
     ) |> 
  select(title, code)
```

```{r}
gdp_tabs |> 
  select(title, code) |> 
  flextable()  |> 
  width(1, width = 3.5) |> 
  width(2, width = 1.5)
```

```{r}
# description nama_10r_3gdp
dsd_gdp <- get_eurostat_dsd("nama_10r_3gdp")
```

```{r}
dsd_gdp |> 
  filter(concept %in% c('freq', 'unit')) |> 
  flextable()  |> 
  width(j = 1, width = 1) |> 
  width(j = 2, width = 2) |> 
  width(j = 3, width = 2)
```

```{r}
dsd_gdp |> 
  filter(concept %in% c('geo')) |> 
  head(n = 10) |> 
  flextable()  |> 
  width(j = 1, width = 1) |> 
  width(j = 2, width = 2) |> 
  width(j = 3, width = 2)
```


```{r}
#| eval: true
#| cache: true
gdp <- get_eurostat_data(
  id = "nama_10r_3gdp",
  filters = list(
    nuts_level = "3",
    unit = "MIO_PPS_EU27_2020"
  ),
  exact_match = FALSE,
  date_filter = 2000:2023,
  stringsAsFactors = FALSE
  ) |> 
  mutate(
    gdp_n3 = 1000000 * values
  ) |> 
  select(-c(unit, values)) |> 
  filter(str_length(geo) == 5) |> 
  as_tibble()
```

```{r}
dim(gdp)
```

```{r}
gdp
```

```{r}
gdp |> 
  filter(geo == "IE053") |> 
  print(n = 25)
```

```{r}
ie_data <- tibble(
  geo = c("IE053", "IE053", "IE053"),
  time = c("2015", "2016", "2017"),
  gdp_n3 = c(NA, NA, NA)
)
```

```{r}
gdp <- rbind(gdp, ie_data)
```

```{r}
gdp <- gdp |> 
  arrange(geo, time) |> 
  mutate(
    gdp_n3 = zoo::na.approx(gdp_n3)
  )
```

```{r}
gdp |> 
  filter(geo == "IE053") |> 
  print(n = 25)
```

# Oppgave 1

```{r}
pop_tab <- toc_txt |>
  filter(
    str_detect(title, regex("population", ignore_case = TRUE)) &
    str_detect(title, regex("NUTS\\s*3", ignore_case = TRUE))
  )
```


# Oppgave 2
## i
```{r}
pop_tab |>
  filter(
    str_detect(title, regex("population", ignore_case = TRUE)) &
    str_detect(title, regex("NUTS\\s*3", ignore_case = TRUE))
  )

```

```{r}
pop_tab |>
  filter(
    str_detect(
      title,
      fixed("Average annual population to calculate regional GDP data (thousand persons) by NUTS 3 region")
    )
  ) |>
  select(code)
```

## ii
```{r}
# Så laster vi ned DSD for tabellen vi fant over.
dsd_pop <- get_eurostat_dsd("nama_10r_3popgdp")
```

#iii-v

```{r}
#| eval: true
#| cache: true
pop <- get_eurostat_data(
 id = "nama_10r_3popgdp",
 filters = list(
 nuts_level = "3",
 unit = "THS"
 ),
 exact_match = FALSE,
 date_filter = 2000:2023,
 stringsAsFactors = FALSE
 ) |>
 mutate(
 pop_n3 = values * 1000
 ) |> 
  select(-c(unit, values)) |>
 filter(str_length(geo) == 5) |> 
 as_tibble()
```

```{r}
dim(pop)
```

```{r}
pop
```

# Oppgave 3

```{r}
gdp_pop <- left_join(
  gdp,
  pop,
  by = c("geo", "time")
)
```

```{r}
dim(gdp_pop)
head(gdp_pop)
```


```{r}
eu_data <- gdp_pop %>%
 # Trenger ikke ZZ sonene som er en slag oppsamlingssone
 # for ikke fordelte verdier
 filter(!str_sub(geo, 3, 4) == "ZZ") |>
 # Drop the EFTA countries Switzerland and Norway
 filter(!str_sub(geo, 1, 2) %in% c("CH", "NO")) |>
 # Drop the EU countries Netherlands and Portugal
 filter(!str_sub(geo, 1, 2) %in% c("NL", "PT")) |>
 # Drop candidate country Monte Negro because of data
 filter(!str_sub(geo, 1, 2) %in% c("ME")) |>
 # Drop a region of France in the Indian Ocean (Outre Mer); Mayotte
 # because of missing data
 filter(!geo == "FRY50") |>
 # note that a few countries will have missing data for
 # some years at the start of the period
 filter(time > 1999 & time < 2023)
```

```{r}
eu_data <- eu_data |>
  mutate(
    gdp_pc_n3 = gdp_n3 / pop_n3
  )
```

```{r}
dim(eu_data)
```

```{r}
miss_eu <- eu_data %>%
  filter(!complete.cases(.))
dim(miss_eu)
```


# Oppgave 4

```{r}
eu_data <- eu_data |>
  rename(
    n3 = geo
  ) |>
  mutate(
    n2 = str_sub(n3, 1, 4),  # NUTS2
    n1 = str_sub(n3, 1, 3),  # NUTS1
    nc = str_sub(n3, 1, 2)   # Country
  )

```

```{r}
# Sjekker at det er riktig
eu_data |>
  select(n3, n2, n1, nc) |>
  distinct() |>
  head(10)

```


# Oppgave 5

```{r}
# Ingen pop_n3 som er lik 0.
eu_data |>
  filter(pop_n3 == 0) |>
  select(n3, time, pop_n3)

```


# Oppgave 6
```{r}
eu_data |>
  distinct(nc, n3) |>
  count(nc, name = "num_nuts3") |>
  arrange(nc) |> 
  
as_flextable()
```
# Oppgave 7

```{r}
# Summary viser at BNP per innbygger på NUTS3-nivå varierer fra en minimumsverdi på 2 214 til en maksimumsverdi på 180 416.
summary(eu_data$gdp_pc_n3)

```

# Oppgave 8

```{r}
eu_data <- eu_data |>
  mutate(
    nc_name = case_when(
      nc == "AL" ~ "Albania",
      nc == "AT" ~ "Østerrike",
      nc == "BE" ~ "Belgia",
      nc == "BG" ~ "Bulgaria",
      nc == "CY" ~ "Kypros",
      nc == "CZ" ~ "Tjekkia",
      nc == "DE" ~ "Tyskland",
      nc == "DK" ~ "Danmark",
      nc == "EE" ~ "Estland",
      nc == "EL" ~ "Hellas",
      nc == "ES" ~ "Spania",
      nc == "FI" ~ "Finland",
      nc == "FR" ~ "Frankrike",
      nc == "HR" ~ "Kroatia",
      nc == "HU" ~ "Ungarn",
      nc == "IE" ~ "Irland",
      nc == "IT" ~ "Italia",
      nc == "LT" ~ "Litauen",
      nc == "LU" ~ "Luxemburg",
      nc == "LV" ~ "Latvia",
      nc == "MK" ~ "Nord-Makedonia",
      nc == "MT" ~ "Malta",
      nc == "PL" ~ "Polen",
      nc == "RO" ~ "Romania",
      nc == "RS" ~ "Serbia",
      nc == "SE" ~ "Sverige",
      nc == "SI" ~ "Slovania",
      nc == "SK" ~ "Slovakia",
      nc == "TR" ~ "Tyrkia",
      TRUE ~ NA_character_
    )
  )

```

```{r}
eu_data |> 
  select(nc_name, nc) |> 
  distinct() |> 
  print(n = 30)
```


# Oppgave 9

```{r}
gini_n2 <- eu_data |>
  group_by(n2, time, n1, nc, nc_name) |> 
  summarise(
    gini_n2 = DescTools::Gini(gdp_pc_n3, weights = pop_n3, na.rm = TRUE),
    pop_n2 = sum(pop_n3),
    gdp_n2 = sum(gdp_n3),
    gdp_pc_n2 =  gdp_n2 / pop_n2,
    num_reg_n2 = n(),
    .groups = "drop" 
  ) 

as_tibble(gini_n2)
```

```{r}
gini_n2 |>
  select(gini_n2, num_reg_n2, pop_n2, gdp_n2, gdp_pc_n2) |>
  summary()

```

# Oppgave 10

```{r}
gini_low <- gini_n2 |>
  filter(!is.na(gini_n2)) |>
  filter(gini_n2 < 0.001)
```

```{r}
gini_low |>
  arrange(gini_n2) |>
  select(nc_name, nc, n1, n2, time, gini_n2, num_reg_n2, pop_n2, gdp_pc_n2)

```
```{r}
#Hvor mange NUTS3 soner de har
gini_low |>
  count(num_reg_n2, sort = TRUE)

```
Regioner med svært lav gini kjennetegnes ved at de består av få NUTS3 regioner. Vi ser at disse regionene har nettopp dette til felles. 



# Oppgave 11

```{r}
gini_n1 <- eu_data |>
  group_by(n1, time, nc, nc_name) |>
  summarise(
    gini_n1 = DescTools::Gini(gdp_pc_n3, weights = pop_n3, na.rm = TRUE),
    pop_n1  = sum(pop_n3),
    gdp_n1  = sum(gdp_n3),
    gdp_pc_n1 = gdp_n1 / pop_n1,
    num_reg_n1 = n(),
    .groups = "drop"
  )

```

```{r}
gini_n1 |>
  select(gini_n1, num_reg_n1, gdp_n1, pop_n1, gdp_pc_n1) |>
  summary() |>
  print(width = 76)

```

# Oppgave 12

```{r}
gini_nc <- eu_data |>
  group_by(nc, time, nc_name) |>
  summarise(
    gini_nc = DescTools::Gini(gdp_pc_n3, weights = pop_n3, na.rm = TRUE),
    pop_nc  = sum(pop_n3),
    gdp_nc  = sum(gdp_n3),
    gdp_pc_nc = gdp_nc / pop_nc,
    num_reg_nc = n(),
    .groups = "drop"
  )

```

```{r}
gini_nc |>
  select(gini_nc, num_reg_nc, gdp_nc, pop_nc, gdp_pc_nc) |>
  summary() |>
  print(width = 80)

```



# Oppgave 13

```{r}
gini_n3_nest <- eu_data |> 
  group_by(nc_name, nc) |> 
  nest(.key = "NUTS3_data") |> 
  ungroup()
```

# Oppgave 14

```{r}
gini_NUTS2_nest <- gini_n2 |> 
  group_by(nc_name, nc) |> 
  nest(.key = "NUTS2_data") |> 
  ungroup()
```

# Oppgave 15

```{r}
gini_NUTS1_nest <- gini_n1 |> 
  group_by(nc_name, nc) |> 
  nest(.key = "NUTS1_data") |> 
  ungroup()
```

# Oppgave 16

```{r}
gini_NUTSc_nest <- gini_nc |> 
  group_by(nc_name, nc) |> 
  nest(.key = "NUTSc_data") |> 
  ungroup()
```

# Oppgave 17

```{r}
gini_NUTSeu_nest <- eu_data |>
  group_by(time) |>
  summarise(
    gini_eu = DescTools::Gini(gdp_pc_n3, weights = pop_n3, na.rm = TRUE),
    num_reg_eu = n(),
    .groups = "drop"
  )

```

# Oppgave 18

```{r}
gini_NUTSeu_nest |>
  ggplot(aes(x = as.numeric(time), y = gini_eu)) +
  geom_line() +
  labs(
    x = "Year",
    y = "gini_eu"
  ) +
  theme_minimal()

```

# Oppgave 19

Figuren viser at den regionale ulikheten målt ved Gini-koeffisienten på NUTS3-nivå, har hatt en fallende trend over tid. Dette kan tyde på at forskjellene mellom regioner har blitt noe mindre, og er i tråd med målsettingene bak EUs politikk. Samtidig må vi være litt kritisk til konklusjonen, ettersom utviklingen også kan påvirkes av andre faktorer som økonomiske konjunkturer, strukturelle endringer og endringer i datagrunnlaget.


# Oppgave 20

```{r}
eu_data_nested <- gini_n3_nest |>
  left_join(gini_NUTS2_nest, by = c("nc", "nc_name")) |>
  left_join(gini_NUTS1_nest, by = c("nc", "nc_name")) |>
  left_join(gini_NUTSc_nest, by = c("nc", "nc_name"))
```

```{r}
view(eu_data_nested)
```


# Oppgave 21

```{r}
gini_nc_label <- gini_nc |> 
  filter(!is.na(gini_nc)) |> 
  group_by(nc_name) |> 
  filter(time == max(time)) |> 
  ungroup()

gini_nc |> 
  filter(!is.na(gini_nc)) |> 
  ggplot(aes(
    x = as.numeric(time),
    y = gini_nc,
    group = nc_name
  )) +
  geom_line(colour = "grey60", alpha = 0.8) +
  geom_text_repel(
    data = gini_nc_label,
    aes(label = nc_name),
    size = 3,
    nudge_x = 0.5,
    segment.alpha = 0.5
  ) +
  labs(
    x = "År",
    y = "Gini-koeffisient (nasjonsnivå)",
    title = "Utvikling i regional ulikhet på nasjonsnivå",
    subtitle = "Gini beregnet fra BNP per innbygger på NUTS3-nivå"
  ) +
  theme_minimal()
```

# Oppgave 22


```{r}
# Lager en tabell som viser GINI på nasjonlt nivå for året 2022, sortert fra lav til høy ulikhet
gini_nc |> 
  filter(time == "2022") |> 
  filter(!is.na(gini_nc)) |> 
  select(
    nc_name,
    gini_nc,
    num_reg_nc,
    gdp_pc_nc
  ) |> 
  arrange(gini_nc) |> 
  mutate(
    gini_nc = round(gini_nc, 3),
    gdp_pc_nc = round(gdp_pc_nc, 0)
  ) |> 
  flextable() |> 
  set_header_labels(
    nc_name   = "Land",
    gini_nc   = "Gini (2022)",
    num_reg_nc = "Antall NUTS3-regioner",
    gdp_pc_nc = "BNP per innbygger"
  ) |> 
  autofit()
```


# Oppgave 23

```{r}
gini_groups <- gini_nc |> 
  filter(!is.na(gini_nc)) |> 
  group_by(nc, nc_name) |> 
  summarise(
    gini_first = gini_nc[which.min(as.numeric(time))],
    gini_2022  = gini_nc[time == "2022"][1],
    .groups = "drop"
  ) |> 
  filter(!is.na(gini_2022)) |> 
  mutate(
    group = case_when(
      gini_2022 < gini_first ~ "Utjevning over tid",
      gini_2022 > gini_first ~ "Økt regional ulikhet",
      TRUE ~ NA_character_
    )
  )
```


```{r}
gini_nc_grouped <- gini_nc |> 
  left_join(
    gini_groups |> select(nc, group),
    by = "nc"
  ) |> 
  filter(!is.na(group))
```

l

```{r}
gini_labels <- gini_nc_grouped |> 
  filter(time == "2022")
```


```{r}
gini_nc_grouped |> 
  ggplot(aes(
    x = as.numeric(time),
    y = gini_nc,
    group = nc_name,
    colour = nc_name
  )) +
  geom_line(alpha = 0.8) +
  facet_wrap(~ group) +
  labs(
    x = "År",
    y = "Gini-koeffisient (nasjonsnivå)",
    colour = "Land",
    title = "Utvikling i regional ulikhet på nasjonsnivå",
    subtitle = "Land gruppert etter endring i Gini fra første observasjonsår til 2022"
  ) +
  theme_minimal() +
  theme(
    legend.position = "right",
    legend.text = element_text(size = 8),
    legend.title = element_text(size = 9)
  )
```

# Oppgave 24


```{r}
gini_n2 |>
  # Filtrer datasettet til kun å inkludere Irland
  filter(nc_name == "Irland") |>
  
  ggplot(aes(
    # Konverter tid til numerisk for x-aksen
    x = as.numeric(time),
    y = gini_n2,
    # Grupper og fargelegg linjene basert på NUTS2-regionen (n2)
    group = n2,
    colour = n2
  )) +
  
  geom_line(alpha = 0.8) +
  
  labs(
    x = "År",
    y = "Gini-koeffisient (NUTS2)",
    colour = "NUTS2 Region",
    title = "Utvikling i regional ulikhet for NUTS2 regioner i Irland",
    subtitle = "Gini beregnet fra BNP per innbygger på NUTS3-nivå"
  ) +
  theme_minimal()
```

# Oppgave 25

```{r}
gini_n2 |>
  # Filtrer datasettet til kun å inkludere Spania
  filter(nc_name == "Spania") |> # Spania er definert i Oppgave 8 [2, 3]
  
  ggplot(aes(
    # Konverter tid til numerisk for x-aksen
    x = as.numeric(time),
    y = gini_n2,
    # Grupper og fargelegg linjene basert på NUTS2-regionen (n2)
    group = n2,
    colour = n2
  )) +
  
  geom_line(alpha = 0.8) +
  
  labs(
    x = "År",
    y = "Gini-koeffisient (NUTS2)",
    colour = "NUTS2 Region",
    title = "Utvikling i regional ulikhet for NUTS2 regioner i Spania",
    subtitle = "Gini beregnet fra BNP per innbygger på NUTS3-nivå"
  ) +
  theme_minimal()
```
# Oppgave 26

```{r}
gini_n1 |>
  # Filtrer datasettet til kun å inkludere Spania
  filter(nc_name == "Spania") |> # Spania ble tildelt nc_name i Oppgave 8 [4]
  
  ggplot(aes(
    # Konverter tid til numerisk for x-aksen
    x = as.numeric(time),
    y = gini_n1,
    # Grupper og fargelegg linjene basert på NUTS1-regionen (n1)
    group = n1,
    colour = n1
  )) +
  
  geom_line(alpha = 0.8) +
  
  labs(
    x = "År",
    y = "Gini-koeffisient (NUTS1)",
    colour = "NUTS1 Region",
    title = "Utvikling i regional ulikhet for NUTS1 regioner i Spania",
    subtitle = "Gini beregnet fra BNP per innbygger på NUTS3-nivå"
  ) +
  theme_minimal()
```



```{r}
gini_n1 |>
  # Filtrer datasettet til kun å inkludere Spania
  filter(nc_name == "Spania") |> # Spania ble tildelt nc_name i Oppgave 8 [4]
  
  ggplot(aes(
    # Konverter tid til numerisk for x-aksen
    x = as.numeric(time),
    y = gini_n1,
    # Grupper og fargelegg linjene basert på NUTS1-regionen (n1)
    group = n1,
    colour = n1
  )) +
  
  geom_line(alpha = 0.8) +
  
  labs(
    x = "År",
    y = "Gini-koeffisient (NUTS1)",
    colour = "NUTS1 Region",
    title = "Utvikling i regional ulikhet for NUTS1 regioner i Spania",
    subtitle = "Gini beregnet fra BNP per innbygger på NUTS3-nivå"
  ) +
  theme_minimal()
```
Som vi kan se i grafen over har flesteparten av NUTS1 regionene i Spania hatt en økt utgjevning i perioden 2000-2022. Dette er når GINI koefisienten har en nedgående trend over en årrekke. ES5 skiller seg ut da den har vist en økning i forskjell. I 2000 var GINI 0,08, og i år 2022 var den på 0,1. 

# Oppgave 27


```{r}
gini_n2 |>
  # Filtrer datasettet til kun å inkludere Tyskland
  filter(nc_name == "Tyskland") |>
  
  ggplot(aes(
    # Konverter tid til numerisk for x-aksen
    x = as.numeric(time),
    y = gini_n2,
    # Grupper linjene basert på NUTS2-regionen (n2)
    group = n2
  )) +
  
  # Bruk en nøytral farge (f.eks. grå) for alle linjer,
  # da det er for mange NUTS2-regioner i Tyskland til å skille dem med farger.
  geom_line(color = "grey50", alpha = 0.8) +
  
  labs(
    x = "År",
    y = "Gini-koeffisient (NUTS2)",
    title = "Utvikling i regional ulikhet for NUTS2 regioner i Tyskland",
    subtitle = "Gini beregnet fra BNP per innbygger på NUTS3-nivå"
  ) +
  theme_minimal()
```
```{r}
#Lager tabell for regioner med GINI over 0,2 for NUTS2 regioner i år 2022
gini_n2 |>
  # 1. Filtrer til Tyskland
  filter(nc_name == "Tyskland") |> # Landskode DE
  # 2. Filtrer til siste observasjonsår (2022) for konsistens
  filter(time == "2022") |> 
  # 3. Filtrer for regioner der Gini-koeffisienten er høyere enn 0.2
  filter(gini_n2 > 0.2) |>
  filter(!is.na(gini_n2)) |>
  
  # Velg ut relevante kolonner
  select(n2, time, gini_n2, pop_n2, gdp_pc_n2) |> 
  
  # Sorter synkende etter Gini-koeffisient for å se de mest ujevne regionene først
  arrange(desc(gini_n2)) |>
  
  # Formatere tall for tabellen
  mutate(
    gini_n2 = round(gini_n2, 4),
    pop_n2 = round(pop_n2, 0),
    gdp_pc_n2 = round(gdp_pc_n2, 0)
  ) |>
  
  # Bruk flextable for pen visning
  flextable() |>
  set_header_labels(
    n2        = "NUTS2 Region",
    time      = "År",
    gini_n2   = "Gini Koeffisient",
    pop_n2    = "Befolkning (NUTS2)",
    gdp_pc_n2 = "BNP per innbygger (NUTS2)"
  ) |>
  autofit()
```

I tabellen over er NUTS regionene som hadde en GINI verdi over 0,2 i 2022 filtrert ut. Dette gir en oversikt over hvilken regioner som har størst ulikhet mellom sine NUTS3 regioner. Av disse 9 reginene ligger DE21, DE25	DE23, DE24 og DE26	i  Bayern NUTS1 regionen. Dette indikerer at i Tyskland finner man størst ulikhet i den sør-østlige delen av landet. 

# Oppgave 28

```{r}
eu_data_nested |>
  unnest(NUTS1_data) |>
  filter(nc_name == "Tyskland") |>
  filter(time == "2022") |>
  select(n1, gini_n1, num_reg_n1) |>
  arrange(desc(gini_n1)) |>
  flextable() |>
  line_spacing(space = 0.3) |>
  colformat_double(j = 2, digits = 4
  )
```

Når vi sammenligner data på NUTS1 nivå med de vi fant på NUTS2 nivå kan vi se lignende trender i en stor spredning i ulket. GINI koefisienten varier fra 0,097 til 0,253 mellom regionene med mest og minst ulikhet. 

# Oppgave 29

```{r}
gini_n1 |>
  # Filtrer datasettet til kun å inkludere Frankrike (FR)
  filter(nc_name == "Frankrike") |>
  
  ggplot(aes(
    # Konverter tid til numerisk for x-aksen
    x = as.numeric(time),
    y = gini_n1,
    # Grupper linjene basert på NUTS1-regionen (n1)
    group = n1,
    # Fargekod linjene basert på NUTS1-regionen
    colour = n1
  )) +
  
  geom_line(alpha = 0.8, linewidth = 1) +
  
  labs(
    x = "År",
    y = "Gini-koeffisient (NUTS1)",
    colour = "NUTS1 Region",
    title = "Utvikling i regional ulikhet for NUTS1 regioner i Frankrike",
    subtitle = "Gini beregnet fra BNP per innbygger på NUTS3-nivå"
  ) +
  theme_minimal() +
  # Juster legendeposisjonen for å optimalisere plottet
  theme(legend.position = "bottom")
```

# oppgave 30

```{r}
gini_n1 |>
  # 1. Filtrer til Frankrike
  filter(nc_name == "Frankrike") |> # Landskode FR
  # 2. Filtrer til siste observasjonsår (2022)
  filter(time == "2022") |> 
  
  # Velg ut relevante kolonner
  select(n1, gini_n1, num_reg_n1, pop_n1) |> 
  
  # Sorter synkende etter Gini-koeffisient for å se de mest ujevne regionene først
  arrange(desc(gini_n1)) |>
  
  # Velg de 6 øverste (høyest Gini)
  head(6) |>
  
  # Formatere tall for tabellen
  mutate(
    gini_n1 = round(gini_n1, 4),
    pop_n1 = round(pop_n1, 0)
  ) |>
  
  # Bruk flextable for pen visning
  flextable() |>
  set_header_labels(
    n1        = "NUTS1 Region",
    gini_n1   = "Gini Koeffisient (2022)",
    num_reg_n1 = "Antall NUTS3-regioner",
    pop_n1    = "Befolkning (NUTS1)"
  ) |>
  autofit()
```
Regionen FR1 har en Gini-koeffisient på 0.3354, som er surevent høyere enn den nest høyeste regionen, FRL (0.2018)

Den sonen som opplever størst ulikhet er ile de france, som er sentrert rundt Paris området. Dette tilsier at områdene med støsrt ulikhet er rundt Frankrikes hovedstad. 

# Oppgave 31

```{r}
FR1_data <- eu_data_nested |>
  unnest(NUTS3_data) |> # Henter ut NUTS3-dataene
  filter(n1 == "FR1")

# Linediagram
FR1_data |>
  ggplot(aes(
    # Konverter tid til numerisk for x-aksen
    x = as.numeric(time),
    y = gdp_pc_n3,
    # Grupper og fargekod linjene basert på NUTS3-regionen (n3)
    group = n3,
    colour = n3
  )) +
  
  geom_line(linewidth = 1) +
  
  # Legger til tekstetiketter for siste år for å identifisere regionene
  geom_text_repel(
    data = FR1_data |> filter(time == max(time)),
    aes(label = n3),
    size = 3,
    nudge_x = 0.5,
    segment.alpha = 0.5
  ) +
  
  labs(
    x = "År",
    y = "BNP per innbygger (NUTS3)",
    title = "Utvikling i BNP per innbygger for NUTS3 regioner i FR1 (Île-de-France)",
    subtitle = "Gini (FR1, 2022) var 0.3354"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```

```{r}
# Tabell 
FR1_data |>
  filter(time == "2022") |>
  select(n3, time, gdp_pc_n3, pop_n3) |>
  
  # Sorter synkende etter BNP per innbygger
  arrange(desc(gdp_pc_n3)) |>
  
  # Velg de 6 øverste sonene
  head(6) |>
  
  # Formatere tall for tabellen
  mutate(
    gdp_pc_n3 = round(gdp_pc_n3, 0),
    pop_n3 = round(pop_n3, 0)
  ) |>
  
  # Bruk flextable for pen visning
  flextable() |>
  set_header_labels(
    n3        = "NUTS3 Region",
    time      = "År",
    gdp_pc_n3 = "BNP per innbygger (2022)",
    pop_n3    = "Befolkning (NUTS3)"
  ) |>
  autofit()
```

#Oppgave 32

I disse illustrasjonene kan vi se at det er to NUTS3 regioner som bidrar til FR1 sin høye GINI verdi. FR101 og FR105 skiller seg kraftig ut fra de andre NUTS3 regionene, med omtrent 3 ganger så mye som den tredje på listen. FR101 er NUTS3 regionen til Paris, mens FR105 er Seine-et-Marne, som er et departemeant øst for Paris. Det tyder sterkt på at ulikhet i og rundt hovedstaden er hovedårsaken til FR1 sin høye grad av ulikhet. 

#Oppgave 33

```{r}
n3_data <- eu_data_nested |>
 unnest(NUTS3_data) |>
 select(nc_name, n2, n3, time, gdp_pc_n3)

```

```{r}
n2_data <- eu_data_nested |>
 unnest(NUTS2_data) |>
 select(nc_name, n2, time, gini_n2)

```


```{r}
NUTS2_diff <- n3_data |>
 left_join(n2_data, by = join_by(nc_name, n2, time)) |>
 mutate(
 diff_gdp_per_capita = c(NA, 100 * diff(gdp_pc_n3)),
 diff_gini_nuts2 = c(NA, 100 * diff(gini_n2))
 ) %>%
 filter(complete.cases(.)) |>
 group_by(nc_name, n2) |>
 nest(.key = "NUTS2_diff")
```

```{r}
unnest(NUTS2_diff, NUTS2_diff) |>
 ungroup() |>
 filter(!is.nan(gini_n2)) |>
 select(n2) |>
 distinct() |>
 nrow()
```

# Oppgave 34

```{r}
NUTS2_diff <- NUTS2_diff  |> 
  group_by(nc_name, n2) |> 
  mutate(
    # 'modell' er den nye listekolonnen som skal lagre de 218 regresjonsmodellene
    modell = map(
      .x = NUTS2_diff,
      # Anonym funksjon som kjører lm på de nestede dataene i 'a_df'
      .f = function(a_df) lm('diff_gini_nuts2 ~ diff_gdp_per_capita', data = a_df)
    )
  )
```

# Oppgave 35

```{r}
UTS2_diff <- NUTS2_diff |>
  group_by(nc_name, n2) |>
  mutate(
    # mod_coeff vil inneholde koeffisientene for hver av de 218 modellene
    mod_coeff = bind_rows(
      map(
        .x = modell,
        .f = coefficients
      )
    )
  )
```

